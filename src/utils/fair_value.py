"""Empirical fair value estimate for 15-min crypto binary markets.

Lookup table maps (dir_move_bucket, minutes_remaining) -> P(win).
Calibrated from Binance BTC+ETH 1-min klines Oct 2025 - Feb 2026.

Reference price = close of the 1st 1-min candle in the 15-min slot.
Ties (final == open) count as losses, matching Polymarket UP resolution
(strict greater-than).
"""

import bisect

# Bucket edges for directional move (%)
_MOVE_EDGES = [-0.50, -0.30, -0.20, -0.10, -0.05, 0.00, 0.05, 0.10, 0.20, 0.30, 0.50]

# (move_bucket_index, minutes_remaining) -> P(win)
# Populated by scripts/calibrate_fair_value.py
# 26,496 fifteen-minute windows, 370,944 observations total
_TABLE: dict[tuple[int, int], float] = {
    ( 0,  1): 0.0000,  # n=1180
    ( 0,  2): 0.0000,  # n=1103
    ( 0,  3): 0.0039,  # n=1036
    ( 0,  4): 0.0122,  # n=982
    ( 0,  5): 0.0182,  # n=881
    ( 0,  6): 0.0235,  # n=810
    ( 0,  7): 0.0326,  # n=737
    ( 0,  8): 0.0524,  # n=668
    ( 0,  9): 0.0524,  # n=553
    ( 0, 10): 0.0748,  # n=428
    ( 0, 11): 0.1288,  # n=326
    ( 0, 12): 0.1757,  # n=222
    ( 0, 13): 0.2576,  # n=132
    ( 0, 14): 0.2800,  # n=50
    ( 1,  1): 0.0000,  # n=1532
    ( 1,  2): 0.0027,  # n=1499
    ( 1,  3): 0.0084,  # n=1421
    ( 1,  4): 0.0155,  # n=1354
    ( 1,  5): 0.0280,  # n=1320
    ( 1,  6): 0.0338,  # n=1243
    ( 1,  7): 0.0585,  # n=1180
    ( 1,  8): 0.0686,  # n=1093
    ( 1,  9): 0.0924,  # n=996
    ( 1, 10): 0.1092,  # n=888
    ( 1, 11): 0.1345,  # n=773
    ( 1, 12): 0.1477,  # n=623
    ( 1, 13): 0.2094,  # n=363
    ( 1, 14): 0.2549,  # n=153
    ( 2,  1): 0.0000,  # n=1716
    ( 2,  2): 0.0057,  # n=1763
    ( 2,  3): 0.0195,  # n=1689
    ( 2,  4): 0.0306,  # n=1668
    ( 2,  5): 0.0387,  # n=1630
    ( 2,  6): 0.0645,  # n=1613
    ( 2,  7): 0.0845,  # n=1491
    ( 2,  8): 0.0999,  # n=1481
    ( 2,  9): 0.1176,  # n=1403
    ( 2, 10): 0.1578,  # n=1280
    ( 2, 11): 0.1878,  # n=1161
    ( 2, 12): 0.2018,  # n=986
    ( 2, 13): 0.2462,  # n=719
    ( 2, 14): 0.3652,  # n=408
    ( 3,  1): 0.0000,  # n=3271
    ( 3,  2): 0.0175,  # n=3201
    ( 3,  3): 0.0372,  # n=3250
    ( 3,  4): 0.0559,  # n=3271
    ( 3,  5): 0.0808,  # n=3219
    ( 3,  6): 0.1117,  # n=3249
    ( 3,  7): 0.1259,  # n=3297
    ( 3,  8): 0.1401,  # n=3183
    ( 3,  9): 0.1869,  # n=3183
    ( 3, 10): 0.2090,  # n=3091
    ( 3, 11): 0.2282,  # n=2993
    ( 3, 12): 0.2472,  # n=2872
    ( 3, 13): 0.2672,  # n=2451
    ( 3, 14): 0.3002,  # n=1719
    ( 4,  1): 0.0000,  # n=2521
    ( 4,  2): 0.0541,  # n=2571
    ( 4,  3): 0.0938,  # n=2613
    ( 4,  4): 0.1327,  # n=2638
    ( 4,  5): 0.1639,  # n=2703
    ( 4,  6): 0.1939,  # n=2759
    ( 4,  7): 0.2275,  # n=2791
    ( 4,  8): 0.2523,  # n=2885
    ( 4,  9): 0.2635,  # n=2899
    ( 4, 10): 0.2786,  # n=2968
    ( 4, 11): 0.3131,  # n=3124
    ( 4, 12): 0.3286,  # n=3156
    ( 4, 13): 0.3299,  # n=3216
    ( 4, 14): 0.3555,  # n=2959
    ( 5,  1): 0.0000,  # n=3073
    ( 5,  2): 0.2079,  # n=3102
    ( 5,  3): 0.2750,  # n=3160
    ( 5,  4): 0.3041,  # n=3232
    ( 5,  5): 0.3363,  # n=3440
    ( 5,  6): 0.3678,  # n=3513
    ( 5,  7): 0.3702,  # n=3652
    ( 5,  8): 0.3924,  # n=3853
    ( 5,  9): 0.4018,  # n=4136
    ( 5, 10): 0.4058,  # n=4409
    ( 5, 11): 0.4162,  # n=4810
    ( 5, 12): 0.4200,  # n=5303
    ( 5, 13): 0.4312,  # n=6387
    ( 5, 14): 0.4516,  # n=7773
    ( 6,  1): 0.9959,  # n=2953
    ( 6,  2): 0.7731,  # n=3068
    ( 6,  3): 0.7063,  # n=3173
    ( 6,  4): 0.6799,  # n=3290
    ( 6,  5): 0.6579,  # n=3420
    ( 6,  6): 0.6273,  # n=3552
    ( 6,  7): 0.6359,  # n=3820
    ( 6,  8): 0.6220,  # n=4040
    ( 6,  9): 0.6127,  # n=4221
    ( 6, 10): 0.5941,  # n=4676
    ( 6, 11): 0.5917,  # n=4994
    ( 6, 12): 0.5794,  # n=5664
    ( 6, 13): 0.5745,  # n=6500
    ( 6, 14): 0.5506,  # n=8328
    ( 7,  1): 1.0000,  # n=2601
    ( 7,  2): 0.9423,  # n=2615
    ( 7,  3): 0.8886,  # n=2748
    ( 7,  4): 0.8547,  # n=2753
    ( 7,  5): 0.8256,  # n=2723
    ( 7,  6): 0.7963,  # n=2867
    ( 7,  7): 0.7631,  # n=2909
    ( 7,  8): 0.7438,  # n=2904
    ( 7,  9): 0.7138,  # n=2959
    ( 7, 10): 0.7009,  # n=3086
    ( 7, 11): 0.6755,  # n=3291
    ( 7, 12): 0.6721,  # n=3272
    ( 7, 13): 0.6680,  # n=3325
    ( 7, 14): 0.6296,  # n=3005
    ( 8,  1): 1.0000,  # n=3329
    ( 8,  2): 0.9807,  # n=3372
    ( 8,  3): 0.9569,  # n=3340
    ( 8,  4): 0.9312,  # n=3429
    ( 8,  5): 0.9075,  # n=3395
    ( 8,  6): 0.8790,  # n=3298
    ( 8,  7): 0.8484,  # n=3285
    ( 8,  8): 0.8312,  # n=3300
    ( 8,  9): 0.7932,  # n=3254
    ( 8, 10): 0.7815,  # n=3135
    ( 8, 11): 0.7641,  # n=2993
    ( 8, 12): 0.7452,  # n=2806
    ( 8, 13): 0.7113,  # n=2307
    ( 8, 14): 0.6809,  # n=1564
    ( 9,  1): 1.0000,  # n=1701
    ( 9,  2): 0.9958,  # n=1679
    ( 9,  3): 0.9847,  # n=1700
    ( 9,  4): 0.9713,  # n=1635
    ( 9,  5): 0.9486,  # n=1673
    ( 9,  6): 0.9362,  # n=1552
    ( 9,  7): 0.9227,  # n=1475
    ( 9,  8): 0.8890,  # n=1432
    ( 9,  9): 0.8755,  # n=1414
    ( 9, 10): 0.8380,  # n=1296
    ( 9, 11): 0.8183,  # n=1095
    ( 9, 12): 0.8022,  # n=900
    ( 9, 13): 0.7447,  # n=658
    ( 9, 14): 0.6788,  # n=330
    (10,  1): 1.0000,  # n=1545
    (10,  2): 0.9993,  # n=1500
    (10,  3): 0.9929,  # n=1416
    (10,  4): 0.9838,  # n=1358
    (10,  5): 0.9685,  # n=1301
    (10,  6): 0.9588,  # n=1286
    (10,  7): 0.9429,  # n=1191
    (10,  8): 0.9280,  # n=1069
    (10,  9): 0.9130,  # n=988
    (10, 10): 0.8938,  # n=866
    (10, 11): 0.8427,  # n=674
    (10, 12): 0.8415,  # n=492
    (10, 13): 0.7814,  # n=334
    (10, 14): 0.7134,  # n=164
    (11,  1): 1.0000,  # n=1074
    (11,  2): 1.0000,  # n=1023
    (11,  3): 0.9979,  # n=950
    (11,  4): 0.9977,  # n=886
    (11,  5): 0.9975,  # n=791
    (11,  6): 0.9814,  # n=754
    (11,  7): 0.9731,  # n=668
    (11,  8): 0.9626,  # n=588
    (11,  9): 0.9490,  # n=490
    (11, 10): 0.9303,  # n=373
    (11, 11): 0.8969,  # n=262
    (11, 12): 0.8950,  # n=200
    (11, 13): 0.8365,  # n=104
    (11, 14): 0.6512,  # n=43
}


def estimate_fair_value(dir_move_pct: float, minutes_remaining: float) -> float:
    """Estimate P(win) for a crypto UP/DOWN market.

    Args:
        dir_move_pct: Directional move of underlying vs slot open (%),
                      positive = in bet direction.
        minutes_remaining: Minutes until market resolution (1-14).

    Returns:
        Estimated probability of winning (0.0-1.0).
    """
    mins = max(1, min(14, round(minutes_remaining)))
    bucket = bisect.bisect_right(_MOVE_EDGES, dir_move_pct)

    fv = _TABLE.get((bucket, mins))
    if fv is not None:
        return fv

    # Fallback: interpolate from adjacent buckets
    for delta in range(1, 4):
        vals = []
        for b in [bucket - delta, bucket + delta]:
            v = _TABLE.get((b, mins))
            if v is not None:
                vals.append(v)
        if vals:
            return sum(vals) / len(vals)

    return 0.50  # no data -> neutral
